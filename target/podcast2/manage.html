<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- vue2 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.13/vue.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!--    引入axios-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        #app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 200px;
            background-color: #f0f0f0;
        }

        .main {
            flex: 1;
            padding: 20px;
        }
        #logspage {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .logs {
            height: 80vh; /* 将高度设置为页面高度的 80% */
            padding: 20px;
            overflow-y: scroll;
            background-color: #f0f0f0;
        }
        .el-table .warning-row {
            background: oldlace;
        }

        .el-table .success-row {
            background: #f0f9eb;
        }
    </style>
    <title>管理</title>
</head>
<body>
    <div id="app">
        <div class="sidebar">
            <el-menu :default-active="activeMenu" class="el-menu-vertical-demo" @select="handleMenuSelect">
                <el-submenu index="system">
                    <template slot="title">系统</template>
                    <el-menu-item index="info">概况</el-menu-item>
                    <el-menu-item index="logs">日志</el-menu-item>
                </el-submenu>

                <el-submenu index="user">
                    <template slot="title">用户</template>
                    <el-menu-item index="changePassword">修改</el-menu-item>
                </el-submenu>
                <el-menu-item index="SubscriptionList" @click="toSubscriptionList">订阅列表</el-menu-item>
                <el-menu-item index="about">关于</el-menu-item>
                <el-menu-item index="exit" @click="exit">退出</el-menu-item>
            </el-menu>
        </div>
        <div class="main">
            <div v-show="activeMenu === 'logs'">
                <title>实时日志页面</title>
                <div id="logspage">
                    <el-card>
                        <div slot="header" class="clearfix">
                            <span>实时日志</span>
                            <el-button style="float: right;" type="danger" @click="clearLogs">清除日志</el-button>
                        </div>
                        <div class="logs">
                            <template v-for="log in logs">
                                <p>{{ log }}</p>
                            </template>
                        </div>
                    </el-card>
                </div>
            </div>

            <div v-show="activeMenu === 'changePassword'"><el-form :inline="true" :model="formInline" class="demo-form-inline">
                <el-form-item label="用户名">
                    <el-input v-model="formInline.user" placeholder="用户名"></el-input>
                </el-form-item>

                <el-form-item label="密码">
                    <el-input v-model="formInline.password" placeholder="密码"></el-input>
                </el-form-item>
                <el-form-item>

                    <el-button type="primary" @click="changeUserPasswd">修改</el-button>
                </el-form-item>
            </el-form></div>

            <div v-show="activeMenu === 'info'">
                <h2>系统概况</h2>
                <el-button type="warning">重启系统</el-button>
                <div>
                    <el-table :data="infoData" :row-class-name="tableRowClassName">
                        <el-table-column prop="key"></el-table-column>
                        <el-table-column prop="value"></el-table-column>
                    </el-table>

                    <h2>插件列表</h2>
                    <div>
                        <el-table
                                :data="systemAllData1.pluginList"
                                style="width: 100%"
                                :row-class-name="tableRowClassName">
                            <el-table-column
                                    prop="name"
                                    label="名称"
                                    width="180">
                            </el-table-column>
                            <el-table-column
                                    prop="version"
                                    label="版本"
                                    width="180">
                            </el-table-column>
                            <el-table-column
                                    label="更新时间"
                                    prop="update">
                            </el-table-column>
                        </el-table>
                </div>
            </div>
        </div>
    </div>
        </div>
    <script>
        new Vue({
            el: "#app",
            data() {
                return {
                    activeMenu: 'home',
                    formInline: {
                        user: '',
                        password: ''
                    },
                    logs: [], // 存储日志信息的数组
                    systemAllData: [],
                    systemAllData1: "",
                    infoData: [
                        { key: "已运行", value: "" },
                        { key: "版本", value: "" },
                        { key: "更新时间", value: "" },
                        { key: "代号", value: "" }
                    ]
                };
            }, mounted: function () {

                // 页面加载完成后，发送异步请求，查询数据
                var _this = this;
                axios({
                    method: "get",
                    url: "./systemInfoServlet"
                }).then(function (resp) {
                    //系统信息
                    _this.systemAllData1 = resp.data;
                    _this.infoData[0].value = resp.data.systemRuntime;
                    _this.infoData[1].value = resp.data.systemVersion;
                    _this.infoData[2].value = resp.data.systemUpdate;
                    _this.infoData[3].value = resp.data.systemCode;

                })
            },
            created() {
                // 建立 WebSocket 连接
                const socket = new WebSocket("ws://192.168.123.3:8088/podcast2/websocket/logs");

                // 监听 WebSocket 连接事件
                socket.onopen = () => {
                    console.log("WebSocket 连接成功");
                };

                // 监听 WebSocket 接收消息事件
                socket.onmessage = (event) => {
                    const message = event.data;
                    this.logs.push(message); // 将接收到的日志信息添加到数组中
                    this.scrollToBottom(); // 滚动到底部
                };

                // 监听 WebSocket 关闭事件
                socket.onclose = () => {
                    console.log("WebSocket 连接关闭");
                };
            },
            methods: {
                handleMenuSelect(index) {
                    this.activeMenu = index;
                },
                clearLogs() {
                    this.logs = []; // 清空日志数组
                },
                scrollToBottom() {
                    this.$nextTick(() => {
                        const logsContainer = this.$el.querySelector(".logs");
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    });
                },
                toSubscriptionList(){
                    window.location.href = "index.html"
                },
                exit(){
                    axios({
                        method:"post",
                        url:"./exitServlet"
                    }).then(function (resp) {
                        if (resp.data==="ok"){
                            window.location.href = "login.html";
                        }
                    })
                },
                //修改用户名和密码
                changeUserPasswd(){
                    axios({
                        method:"post",
                        url:"./changeServlet",
                        data:"username="+this.formInline.user+"&password="+this.formInline.password
                    }).then(function (resp) {
                        if (resp.data=="ok"){
                            window.location.href = "login.html";
                        }
                    })
                },
                tableRowClassName({row, rowIndex}) {
                    if (rowIndex === 1) {
                        return 'warning-row';
                    } else if (rowIndex === 3) {
                        return 'success-row';
                    }
                    return '';
                }
            },
        });
    </script>
</body>
</html>
