<!DOCTYPE html>
<html lang="en" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订阅列表</title>
    <!-- vue2 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.13/vue.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!--    引入axios-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .el-table .warning-row {
            background: oldlace;
        }

        .el-table .success-row {
            background: #f0f9eb;
        }

        .footer {
            position: fixed;
            bottom: 20px;
            /* 上提的距离 */
            left: 0;
            width: 100%;
            text-align: center;
        }

        .footer a {
            /*color: #01A2FF;*/
            margin-right: 10px;
            /* 右边距的设置 */
            text-decoration: none;
            /* 去除下划线 */
            font-size: 20px;
            /* 字体大小设置为25像素 */
            font-weight: bold;
            /* 字体加粗 */
        }
    </style>
</head>

<body>
    <div id="app">
        <el-table ref="multipleTable" :data="tableData" tooltip-effect="dark" style="width: 100%"
                  @selection-change="handleSelectionChange">
            <el-table-column type="selection" width="55">
            </el-table-column>
            <el-table-column type="index" width="50">
            </el-table-column>
            <el-table-column label="更新时间" width="120" prop="updateTimestamp">
                <!-- <template slot-scope="scope">{{ scope.row.date }}</template> -->
            </el-table-column>

            <el-table-column prop="channelTitle" label="频道名称" show-overflow-tooltip>
            </el-table-column>

            <el-table-column label="操作">
                <template slot-scope="scope">
                    <el-button size="mini" type="success" plain
                        @click="copyToClipboard(scope.row.uuid)">复制URL</el-button>
                    <el-button size="mini" type="success" plain  @click="changeUrl(scope.row.uuid)">二维码
                    </el-button>
                    <el-button size="mini" type="danger" plain
                        @click="dele(scope.row.uuid)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>

        </el-table>

        <!-- 页面底部的控制按钮 -->
        <div class="footer">
            <el-button type="primary" size="mini" @click="toAdd">添加订阅</el-button>
            <el-button type="primary" plain size="mini" @click="toManage">管理</el-button>
            <el-dropdown>
                <el-button type="primary" size="mini" plain>
                    更多<i class="el-icon-arrow-down el-icon--right"></i>
                </el-button>
                <el-dropdown-menu slot="dropdown">
                    <el-dropdown-item @click.native="deletes">批量删除</el-dropdown-item>
                    <el-dropdown-item @click.native="downloadOPML">生成OPML</el-dropdown-item>
                </el-dropdown-menu>
            </el-dropdown>
        </div>

        <!-- 弹出二维码 -->
        <el-dialog :visible.sync="dialogVisible" width="310px" :before-close="handleClose">
            <img v-bind:src="qrurl" width="270px" height="270px"  >

            <span slot="footer" class="dialog-footer">
                <el-button @click="dialogCopyURL">复制链接</el-button>
                <el-button type="primary" @click="dialogVisible = false">关闭窗口</el-button>
            </span>
        </el-dialog>
    </div>

    <script>
        new Vue({
            el: "#app",
            data() {
                return {
                    tableData: [],
                    dialogVisible: false,
                    qrurl: "",
                    selecteUuid :[],
                    _uuid:""
                }
            },
            mounted() {
                // 页面加载完成后，发送异步请求，查询数据
                var _this = this;

                axios({
                    method: "post",
                    url: "./selectAllServlet"
                }).then(function (resp) {
                    _this.tableData = resp.data;
                })
            },
            methods: {
                // 跳转到管理页面
                toManage() {
                    window.location.href = "manage.html"
                },
                // 跳转到添加订阅页面
                toAdd() {
                    window.location.href = "add.html"
                },
                // 关闭二维码弹出框
                handleClose(done) {
                    done();
                },
                changeUrl(uuid){
                    this.dialogVisible = true;
                    this.qrurl = "https://api.pwmqr.com/qrcode/create/?url=http://"+window.location.host+"/podcast2/xml/"+uuid+".xml";
                    this._uuid = uuid;
                },
                dele(uuid) {
                    axios({
                        method: "post",
                        url: "./deleteServlet",
                        data: "uuid="+uuid
                    });
                    window.location.reload();
                    this.open3()
                },
                toggleSelection(rows) {
                    if (rows) {
                        rows.forEach(row => {
                            this.$refs.multipleTable.toggleRowSelection(row);
                        });
                    } else {
                        this.$refs.multipleTable.clearSelection();
                    }
                },
                handleSelectionChange(selection) {
                    // 在这里处理选中变化的逻辑
                    // console.log(selection); // 输出选中的行数据
                    //获取被选中的uuid
                    for (let i = 0; i < selection.length; i++) {
                        this.selecteUuid[i] = selection[i].uuid
                    }
                },
                deletes() {
                    // 在这里处理用户点击“批量删除”菜单选项的逻辑
                    for (let i = 0; i < this.selecteUuid.length; i++) {
                        axios({
                            method: "post",
                            url: "./deleteServlet",
                            data: "uuid="+this.selecteUuid[i]
                        });
                    }
                    window.location.reload();
                },
                downloadOPML() {
                    let text = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
                    text += "<opml version=\"1.0\">\n";
                    text += "  <head>\n";
                    text += "    <title>OPML</title>\n";
                    text += "  </head>\n";
                    text += "  <body>\n";
                    for (let i = 0; i < this.selecteUuid.length; i++) {
                        text += "    <outline type=\"rss\"  xmlUrl=\""+"http://"+window.location.host+"/podcast2/xml/"+this.selecteUuid[i]+".xml\" />\n"
                    }
                    text += "  </body>\n";
                    text += "</opml>\n";

                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', 'opml.opml');
                    document.body.appendChild(link);
                    link.click();
                },
                copyToClipboard(uuid) {
                    //点击复制URL
                    const textarea = document.createElement('textarea');
                    textarea.value = "http://"+window.location.host+"/podcast2/xml/"+uuid+".xml"
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    //提示复制成功
                    this.open2();
                    console.log('内容已成功复制到剪贴板');
                },
                dialogCopyURL(){
                    //复制URL
                    this.copyToClipboard(this._uuid)
                    //关闭对话框
                    this.dialogVisible = false;

                },open2() {
                    this.$message({
                        message: '复制成功！',
                        type: 'success'
                    });
                },open3() {
                    this.$message({
                        message: '删除成功！',
                        type: 'success'
                    });
                },open4() {
                    this.$message.error("删除失败！")
                }
            }
        })
    </script>
</body>

</html>